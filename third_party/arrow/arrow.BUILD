load("@rules_foreign_cc//foreign_cc:defs.bzl", "cmake")

package(default_visibility = ["//visibility:public"])

filegroup(
    name = "all_srcs",
    srcs = glob(["**"]),
)

cmake(
    name = "arrow",
    build_args = [
        "-j `nproc`",
    ],
    cache_entries = {
        "CMAKE_INSTALL_LIBDIR": "lib",
        "CMAKE_TOOLCHAIN_FILE": "",
        "CMAKE_C_FLAGS": "-fPIC -I/usr/include -fvisibility=hidden",
        "CMAKE_CXX_FLAGS": "-fPIC -I/usr/include -fvisibility=hidden",
        "EP_COMMON_CMAKE_ARGS": "-DWITH_OPENSSL=OFF",
        "CMAKE_BUILD_TYPE": "release",
        "ARROW_BUILD_SHARED": "OFF",
        "ARROW_BUILD_STATIC": "ON",
        "ARROW_BUILD_TESTS": "OFF",
        "ARROW_CSV": "ON",
        "ARROW_DATASET": "ON",
        "ARROW_PARQUET": "ON",
        # "ARROW_JEMALLOC": "ON",
        # "ARROW_JEMALLOC_INCLUDE_DIR": "$EXT_BUILD_DEPS/jemalloc",
        "ARROW_IPC": "ON",
        "ARROW_DEPENDENCY_SOURCE": "AUTO",  # TODO: Use SYSTEM provided deps
        "ARROW_WITH_SNAPPY": "ON",
        "ARROW_WITH_ZSTD": "ON",
        "ARROW_WITH_BZ2": "ON",
        "ARROW_WITH_LZ4": "ON",
        "ARROW_WITH_ZLIB": "OFF",
        "ARROW_WITH_BROTLI": "OFF",
        "ARROW_WITH_RE2": "OFF",
        "ARROW_WITH_UTF8PROC": "OFF",
        "ARROW_HDFS": "ON",
        "ARROW_TENSORFLOW": "ON",
        "ARROW_FILESYSTEM": "ON",
        # "ARROW_S3": "ON",
        # "ARROW_USE_OPENSSL": "OFF",
        # "OPENSSL_ROOT_DIR": "$EXT_BUILD_DEPS/openssl",
        "BROTLI_ROOT": "$EXT_BUILD_DEPS",
        "Thrift_ROOT": "$EXT_BUILD_DEPS/org_apache_thrift",
    },
    # copts = [
    #     # "-Werror=pedantic",
    #     "-Wno-pedantic",
    # ],
    defines = [
        # "ARROW_USE_OPENSSL=OFF",
    ],
    generate_args = [
        "-GNinja",
        "-DCMAKE_RANLIB=/usr/bin/ranlib",
    ],
    lib_source = ":all_srcs",
    linkopts = ["-pthread"],
    out_static_libs = [
        "libparquet.a",
        "libarrow.a",
        "libarrow_bundled_dependencies.a",
        "libarrow_dataset.a",
        "libarrow_acero.a",
    ],
    tags = ["requires-network"],
    working_directory = "cpp",
    deps = [
        "@com_github_facebook_zstd//:zstd",
        # "@jemalloc",
        "@curl",
        # "@boringssl//:crypto",
        # "@boringssl//:ssl",
        # "@aws-sdk-cpp//:identity-management",
        # "@aws-sdk-cpp//:s3",
        # "@openssl",
        "@boost//:algorithm",
        "@boost//:locale",
        "@boost//:multiprecision",
        "@boost//:tokenizer",
        "@com_github_google_snappy//:snappy",
        "@com_github_google_brotli//:brotli",
        # "@org_apache_thrift//:thrift",
        "@com_github_xtensorstack_xsimd//:xsimd",
        # "@lz4",
        # "@org_bzip_bzip2//:bzip2",
    ],
)
