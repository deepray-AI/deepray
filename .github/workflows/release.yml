name: deepray-release

on:
  release:
    types: [published]
    tags:
      - v*
  push:
    branches:
      - main
      - master
      - r*
  pull_request:
    branches:
      - main
      - master
      - r*
      - hotfix

permissions:
  contents: read

env:
  MIN_PY_VERSION: '3.9'
  MAX_PY_VERSION: '3.11'

jobs:

  upload-dev-container:
    name: Upload dev container to DockerHub
    # needs: [release-wheel, test-with-bazel]
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        py-version: [
            "3.9",
            "3.10",
            "3.11"
          ]
        tf-version: ["2.15.0"]
      fail-fast: false
    if: (github.event_name == 'push' && github.ref == 'refs/heads/master')
    steps:
      - uses: actions/checkout@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

        env:
          PY_VERSION: ${{ matrix.py-version }}
          TF_VERSION: ${{ matrix.tf-version }}
      - run: |
          set -e -x
          bash tools/build_dev_container.sh ${PY_VERSION} ${TF_VERSION}
          docker push hailinfufu/deepray-dev:latest-gpu-py${PY_VERSION}-tf${TF_VERSION}-cu12.2.2-ubuntu22.04
